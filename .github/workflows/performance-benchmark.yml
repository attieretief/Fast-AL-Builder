name: Performance Benchmark

on:
  pull_request:
    branches: [master, main]
    paths:
      - 'scripts/**'
  workflow_dispatch:

jobs:
  # Benchmark Python script performance
  benchmark-scripts:
    name: Benchmark Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
          pip install pytest-benchmark memory_profiler
      
      - name: Benchmark current PR
        run: |
          echo "## üìä Performance Benchmarks - PR Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Benchmark al_builder.py startup
          echo "### AL Builder Startup Time" >> $GITHUB_STEP_SUMMARY
          { time python scripts/al_builder.py --help; } 2>&1 | tee pr-startup.txt
          
          # Benchmark project analysis
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Analysis Time" >> $GITHUB_STEP_SUMMARY
          cd test-al-project
          { time python ../scripts/analyze_project.py; } 2>&1 | tee ../pr-analyze.txt
          cd ..
          
          # Save benchmark results
          mkdir -p benchmark-results
          mv pr-*.txt benchmark-results/
      
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          clean: false
      
      - name: Benchmark base branch
        run: |
          echo "## üìä Performance Benchmarks - Base Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Benchmark al_builder.py startup
          echo "### AL Builder Startup Time" >> $GITHUB_STEP_SUMMARY
          { time python scripts/al_builder.py --help; } 2>&1 | tee base-startup.txt
          
          # Benchmark project analysis
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Analysis Time" >> $GITHUB_STEP_SUMMARY
          cd test-al-project
          { time python ../scripts/analyze_project.py; } 2>&1 | tee ../base-analyze.txt
          cd ..
          
          # Save benchmark results
          mv base-*.txt benchmark-results/
      
      - name: Compare results
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìà Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract real time from both runs
          PR_STARTUP=$(grep "real" benchmark-results/pr-startup.txt | awk '{print $2}')
          BASE_STARTUP=$(grep "real" benchmark-results/base-startup.txt | awk '{print $2}')
          
          echo "| Metric | Base | PR | Change |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Startup Time | $BASE_STARTUP | $PR_STARTUP | - |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>PR Branch - Startup</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat benchmark-results/pr-startup.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Base Branch - Startup</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat benchmark-results/base-startup.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results/

  # Benchmark build performance
  benchmark-build:
    name: Benchmark Build Time
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r scripts/requirements.txt
      
      - name: Benchmark full build (no symbols)
        run: |
          echo "## üèóÔ∏è Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Time the full build process
          START_TIME=$(date +%s)
          cd test-al-project
          python ../scripts/install_al_compiler.py
          python ../scripts/build_extension.py test
          END_TIME=$(date +%s)
          
          DURATION=$((END_TIME - START_TIME))
          echo "### Build Completion Time" >> $GITHUB_STEP_SUMMARY
          echo "‚è±Ô∏è Total: ${DURATION}s" >> $GITHUB_STEP_SUMMARY

  # Memory profiling
  memory-profile:
    name: Memory Profile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
          pip install memory_profiler matplotlib
      
      - name: Profile memory usage
        run: |
          echo "## üíæ Memory Usage Profile" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run memory profiler on key scripts
          python -m memory_profiler scripts/al_builder.py --help 2>&1 | tee memory-profile.txt || true
          
          # Show peak memory usage
          PEAK_MEM=$(grep "peak memory" memory-profile.txt | tail -1 || echo "N/A")
          echo "Peak Memory: $PEAK_MEM" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Full Memory Profile</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat memory-profile.txt >> $GITHUB_STEP_SUMMARY || echo "No profile data"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  # Action execution benchmark
  action-benchmark:
    name: Benchmark Action Execution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Record start time
        id: start
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Run action
        uses: ./
        with:
          build-mode: test
          skip-symbols: 'true'
          skip-signing: 'true'
          skip-publishing: 'true'
      
      - name: Calculate execution time
        run: |
          START_TIME=${{ steps.start.outputs.start_time }}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "## ‚ö° Action Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total Duration: ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          
          # Performance targets
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Targets" >> $GITHUB_STEP_SUMMARY
          if [ $DURATION -lt 60 ]; then
            echo "‚úÖ Excellent (<60s)" >> $GITHUB_STEP_SUMMARY
          elif [ $DURATION -lt 120 ]; then
            echo "‚ö†Ô∏è Good (<2m)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Needs optimization (>2m)" >> $GITHUB_STEP_SUMMARY
          fi

  # Code complexity analysis
  complexity-analysis:
    name: Code Complexity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install tools
        run: pip install radon
      
      - name: Analyze cyclomatic complexity
        run: |
          echo "## üîç Code Complexity Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run radon for cyclomatic complexity
          radon cc scripts/ -a -s > complexity.txt
          
          echo "### Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat complexity.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Analyze maintainability index
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Maintainability Index" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          radon mi scripts/ -s >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Performance summary
  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [benchmark-scripts, benchmark-build, action-benchmark, complexity-analysis]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# üéØ Performance Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Script Benchmarks | ${{ needs.benchmark-scripts.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Benchmark | ${{ needs.benchmark-build.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action Benchmark | ${{ needs.action-benchmark.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Complexity Analysis | ${{ needs.complexity-analysis.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° Review individual job outputs for detailed metrics" >> $GITHUB_STEP_SUMMARY
