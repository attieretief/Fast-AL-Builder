name: PR Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  # Validate PR has proper description
  validate-pr-description:
    name: Validate PR Description
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description exists
        if: ${{ github.event.pull_request.body == '' }}
        run: |
          echo "::error::PR description is required. Please provide a description of your changes."
          exit 1
      
      - name: Check PR description length
        run: |
          DESCRIPTION="${{ github.event.pull_request.body }}"
          LENGTH=${#DESCRIPTION}
          if [ $LENGTH -lt 20 ]; then
            echo "::warning::PR description is very short ($LENGTH characters). Consider adding more details."
          fi
          echo "âœ… PR description: $LENGTH characters"

  # Check for breaking changes
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check action.yml for breaking changes
        run: |
          echo "## Breaking Change Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Check if action.yml was modified
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q "action.yml"; then
            echo "âš ï¸ action.yml was modified" >> $GITHUB_STEP_SUMMARY
            
            # Check for removed required inputs
            REMOVED_REQUIRED=$(git diff origin/${{ github.base_ref }}...HEAD -- action.yml | grep "^-.*required: true" || true)
            if [ ! -z "$REMOVED_REQUIRED" ]; then
              echo "::warning::Potential breaking change: Required inputs may have been removed"
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš ï¸ Potential Breaking Changes Detected" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
              echo "$REMOVED_REQUIRED" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for removed outputs
            REMOVED_OUTPUTS=$(git diff origin/${{ github.base_ref }}...HEAD -- action.yml | grep "^-  [a-z-]*:" | grep -A 2 "outputs:" || true)
            if [ ! -z "$REMOVED_OUTPUTS" ]; then
              echo "::warning::Potential breaking change: Outputs may have been removed"
            fi
          else
            echo "âœ… action.yml unchanged" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check for API changes in Python scripts
        run: |
          # Check if main entry points changed
          if git diff origin/${{ github.base_ref }}...HEAD -- scripts/al_builder.py | grep -E "^-def (run|main|execute)" > /dev/null; then
            echo "::warning::Main entry point functions may have changed"
          fi

  # Validate changelog update
  changelog-check:
    name: Changelog Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if CHANGELOG.md was updated
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q "CHANGELOG.md"; then
            echo "âœ… CHANGELOG.md was updated"
            echo "## Changelog" >> $GITHUB_STEP_SUMMARY
            echo "âœ… CHANGELOG.md updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "::warning::CHANGELOG.md was not updated. Consider documenting your changes."
            echo "## Changelog" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ CHANGELOG.md not updated" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Validate changelog format
        if: ${{ success() }}
        run: |
          # Check for version header in unreleased section
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "âœ… Unreleased section exists"
          else
            echo "::warning::No [Unreleased] section in CHANGELOG.md"
          fi

  # Check for test coverage
  test-coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if tests were added for new code
        run: |
          echo "## Test Coverage Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Get list of modified Python files in scripts/
          MODIFIED_SCRIPTS=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep "scripts/.*\.py$" || true)
          
          if [ ! -z "$MODIFIED_SCRIPTS" ]; then
            echo "### Modified Scripts:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MODIFIED_SCRIPTS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # Check if corresponding tests exist
            MODIFIED_TESTS=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep "tests/.*\.py$" || true)
            
            if [ -z "$MODIFIED_TESTS" ]; then
              echo "::warning::Python scripts modified but no tests were updated. Consider adding tests."
              echo "âš ï¸ No test files modified" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Test files modified" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… No Python scripts modified" >> $GITHUB_STEP_SUMMARY
          fi

  # Verify PR labels
  label-check:
    name: PR Label Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR labels
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          echo "PR Labels: $LABELS"
          
          if [ "$LABELS" = "[]" ]; then
            echo "::warning::No labels applied to this PR. Consider adding labels like 'enhancement', 'bug', 'documentation', etc."
          else
            echo "âœ… PR has labels: $LABELS"
          fi

  # Check PR title format
  title-check:
    name: PR Title Check
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $TITLE"
          
          # Check for conventional commit format (optional)
          if echo "$TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci)(\(.+\))?:"; then
            echo "âœ… PR title follows conventional commit format"
          else
            echo "::notice::Consider using conventional commit format: type(scope): description"
            echo "Examples: feat: add new feature, fix: resolve bug, docs: update README"
          fi
          
          # Check title length
          LENGTH=${#TITLE}
          if [ $LENGTH -gt 72 ]; then
            echo "::warning::PR title is quite long ($LENGTH characters). Consider keeping it under 72 characters."
          fi

  # Validate file changes
  file-validation:
    name: File Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for suspicious file changes
        run: |
          echo "## File Change Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Check for changes to sensitive files
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "\.(env|secret|key|pem|pfx)$"; then
            echo "::error::Sensitive files detected in PR. Please remove them."
            echo "ðŸš¨ Sensitive files detected" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check for large files
          LARGE_FILES=$(git diff origin/${{ github.base_ref }}...HEAD --stat | grep -E " \| +[0-9]{4,} " || true)
          if [ ! -z "$LARGE_FILES" ]; then
            echo "::warning::Large file changes detected:"
            echo "$LARGE_FILES"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Large Files" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$LARGE_FILES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "âœ… File validation complete" >> $GITHUB_STEP_SUMMARY

  # Check dependencies
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if requirements.txt was modified
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q "scripts/requirements.txt"; then
            echo "## Dependency Changes" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ requirements.txt was modified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
            git diff origin/${{ github.base_ref }}...HEAD -- scripts/requirements.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "::notice::Dependencies were modified. Ensure they are necessary and well-tested."
          fi

  # Security scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install security tools
        run: |
          pip install bandit safety
      
      - name: Run Bandit security scan
        run: |
          bandit -r scripts/ -f json -o bandit-report.json || true
          bandit -r scripts/ || true
        continue-on-error: true
      
      - name: Check dependencies for vulnerabilities
        run: |
          safety check -r scripts/requirements.txt --json || true
          safety check -r scripts/requirements.txt || echo "::warning::Some dependencies may have known vulnerabilities"
        continue-on-error: true

  # Quality gate summary
  quality-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: 
      - validate-pr-description
      - breaking-changes
      - changelog-check
      - test-coverage
      - file-validation
      - dependency-check
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš¦ Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Description | ${{ needs.validate-pr-description.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Breaking Changes | ${{ needs.breaking-changes.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changelog | ${{ needs.changelog-check.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.test-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Validation | ${{ needs.file-validation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.dependency-check.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Check critical failures
        if: |
          needs.validate-pr-description.result == 'failure' ||
          needs.file-validation.result == 'failure'
        run: |
          echo "::error::Critical quality checks failed"
          exit 1
